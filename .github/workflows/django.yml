name: django_ci

on:
  push:
    branches: ["main"]

  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # RUN TESTS ON THE SPECIFIC PYTHON VERSION YOUR PROJECT USES
        python-version: ["3.11.14"]

    # ADD THE POSTGRESQL DATABASE SERVICE
    services:
      postgres:
        image: postgres:16-alpine

        # PROVIDE THE DATABASE CREDENTIALS AS ENVIRONMENT VARIABLES
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password

        # HEALTH CHECK TO WAIT UNTIL THE DATABASE IS READY
        options: >-
          --health-cmd pg_isready
          --health-interval 16s
          --health-timeout 8s
          --health-retries 4

        ports:
          # MAP THE SERVICE'S PORT 5432 TO THE RUNNER'S PORT 5432
          - 5432:5432

    steps:
      - name: INIT - CHECKOUT
        uses: actions/checkout@v4

      - name: INIT - PYTHON ${{ matrix.python-version }}
        uses: actions/setup-python@v4

        with:
          python-version: ${{ matrix.python-version }}

      - name: INIT - POETRY
        uses: snok/install-poetry@v1

      - name: CACHE - POETRY
        uses: actions/cache@v4

        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: POETRY - DEPS
        run: poetry install --no-interaction

      - name: BLACK - CODE QUALITY
        run: |
          bash scripts/format.sh check

      - name: PYTEST - UNIT TESTS
        # PROVIDE THE DATABASE CREDENTIALS AND OTHER SETTINGS TO DJANGO
        env:
          # DJANGO SETTINGS
          SECRET_KEY: "a-secret-key-for-testing"
          DEBUG: "0"

          # DATABASE SETTINGS (MUST MATCH THE 'SERVICES' BLOCK)
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password

          # THE SERVICE IS MAPPED TO THE RUNNER'S LOCALHOST
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
        run: |
          poetry run pytest
